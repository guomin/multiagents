<template>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="text-center mb-12 slide-in-up">
      <div class="hero-gradient inline-block p-4 rounded-3xl mb-6 shadow-2xl float-animation">
        <ElIcon class="text-white text-5xl"><InfoFilled /></ElIcon>
      </div>
      <h1 class="text-5xl font-bold text-gradient mb-4">åˆ›å»ºå±•è§ˆé¡¹ç›®</h1>
      <p class="text-gray-600 text-xl max-w-2xl mx-auto">
        å¡«å†™å±•è§ˆéœ€æ±‚ï¼Œè®©6ä¸ªä¸“ä¸šæ™ºèƒ½ä½“ä¸ºæ‚¨è®¾è®¡å®Œæ•´çš„å±•é™ˆæ–¹æ¡ˆ
      </p>
      <div class="flex justify-center items-center mt-6 space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-600">æ™ºèƒ½åä½œ</span>
        </div>
        <div class="text-gray-400">â€¢</div>
        <div class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-600">å®æ—¶ç”Ÿæˆ</span>
        </div>
        <div class="text-gray-400">â€¢</div>
        <div class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-600">ä¸“ä¸šæ–¹æ¡ˆ</span>
        </div>
      </div>
    </div>

    <!-- è¡¨å• -->
    <ElForm
      ref="formRef"
      :model="form"
      :rules="rules"
      label-width="120px"
      class="form-glass slide-in-up"
      style="animation-delay: 0.3s"
    >
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div class="mb-10">
        <div class="flex items-center mb-8">
          <div class="info-gradient p-3 rounded-xl mr-4">
            <ElIcon class="text-white text-xl"><InfoFilled /></ElIcon>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gradient">åŸºæœ¬ä¿¡æ¯</h2>
            <p class="text-gray-600">æè¿°å±•è§ˆçš„åŸºæœ¬ä¿¡æ¯å’Œæ ¸å¿ƒç†å¿µ</p>
          </div>
        </div>

        <ElFormItem label="å±•è§ˆåç§°" prop="title">
          <ElInput
            v-model="form.title"
            placeholder="è¯·è¾“å…¥å±•è§ˆåç§°"
            :maxlength="50"
            show-word-limit
          />
        </ElFormItem>

        <ElFormItem label="å±•è§ˆä¸»é¢˜" prop="theme">
          <ElInput
            v-model="form.theme"
            type="textarea"
            :rows="3"
            placeholder="è¯·è¯¦ç»†æè¿°å±•è§ˆä¸»é¢˜å’Œæ ¸å¿ƒç†å¿µ"
            :maxlength="200"
            show-word-limit
          />
        </ElFormItem>

        <ElFormItem label="ç›®æ ‡å—ä¼—" prop="targetAudience">
          <ElSelect
            v-model="form.targetAudience"
            placeholder="è¯·é€‰æ‹©ç›®æ ‡å—ä¼—"
            class="w-full"
          >
            <ElOption label="å„¿ç«¥åŠå®¶åº­" value="children_family" />
            <ElOption label="é’å°‘å¹´" value="teenagers" />
            <ElOption label="å¤§å­¦ç”Ÿ" value="students" />
            <ElOption label="ä¸“ä¸šäººå£«" value="professionals" />
            <ElOption label="æ™®é€šå¤§ä¼—" value="general_public" />
            <ElOption label="VIPå®¢æˆ·" value="vip_clients" />
          </ElSelect>
        </ElFormItem>
      </div>

      <!-- åœºåœ°ä¿¡æ¯ -->
      <div class="mb-10">
        <div class="flex items-center mb-8">
          <div class="success-gradient p-3 rounded-xl mr-4">
            <ElIcon class="text-white text-xl"><Location /></ElIcon>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gradient">åœºåœ°ä¿¡æ¯</h2>
            <p class="text-gray-600">æè¿°å±•è§ˆåœºåœ°çš„ç©ºé—´ç‰¹å¾å’Œé™åˆ¶æ¡ä»¶</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <ElFormItem label="åœºåœ°é¢ç§¯" prop="venueSpace.area">
            <ElInputNumber
              v-model="form.venueSpace.area"
              :min="50"
              :max="5000"
              class="w-full"
            />
            <span class="ml-2 text-gray-600">å¹³æ–¹ç±³</span>
          </ElFormItem>

          <ElFormItem label="åœºåœ°é«˜åº¦" prop="venueSpace.height">
            <ElInputNumber
              v-model="form.venueSpace.height"
              :min="2"
              :max="10"
              :precision="1"
              class="w-full"
            />
            <span class="ml-2 text-gray-600">ç±³</span>
          </ElFormItem>
        </div>

        <ElFormItem label="åœºåœ°å¸ƒå±€" prop="venueSpace.layout">
          <ElInput
            v-model="form.venueSpace.layout"
            type="textarea"
            :rows="2"
            placeholder="è¯·æè¿°åœºåœ°çš„åŸºæœ¬å¸ƒå±€ç‰¹ç‚¹ï¼Œå¦‚æ˜¯å¦æœ‰æŸ±å­ã€å¤©äº•ç­‰"
          />
        </ElFormItem>
      </div>

      <!-- é¢„ç®—ä¿¡æ¯ -->
      <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">
          <ElIcon class="mr-2 text-yellow-600"><Money /></ElIcon>
          é¢„ç®—ä¿¡æ¯
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <ElFormItem label="æ€»é¢„ç®—" prop="budget.total">
            <ElInputNumber
              v-model="form.budget.total"
              :min="10000"
              :max="10000000"
              class="w-full"
            />
          </ElFormItem>

          <ElFormItem label="è´§å¸å•ä½" prop="budget.currency">
            <ElSelect v-model="form.budget.currency" class="w-full">
              <ElOption label="äººæ°‘å¸ (CNY)" value="CNY" />
              <ElOption label="ç¾å…ƒ (USD)" value="USD" />
              <ElOption label="æ¬§å…ƒ (EUR)" value="EUR" />
            </ElSelect>
          </ElFormItem>
        </div>
      </div>

      <!-- å±•æœŸä¿¡æ¯ -->
      <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">
          <ElIcon class="mr-2 text-purple-600"><Calendar /></ElIcon>
          å±•æœŸä¿¡æ¯
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <ElFormItem label="å¼€å§‹æ—¥æœŸ" prop="duration.startDate">
            <ElDatePicker
              v-model="form.duration.startDate"
              type="date"
              placeholder="é€‰æ‹©å¼€å§‹æ—¥æœŸ"
              class="w-full"
            />
          </ElFormItem>

          <ElFormItem label="ç»“æŸæ—¥æœŸ" prop="duration.endDate">
            <ElDatePicker
              v-model="form.duration.endDate"
              type="date"
              placeholder="é€‰æ‹©ç»“æŸæ—¥æœŸ"
              class="w-full"
            />
          </ElFormItem>
        </div>
      </div>

      <!-- ç‰¹æ®Šè¦æ±‚ -->
      <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">
          <ElIcon class="mr-2 text-red-600"><Star /></ElIcon>
          ç‰¹æ®Šè¦æ±‚
        </h2>

        <ElFormItem label="ç‰¹æ®Šè¦æ±‚">
          <ElSelect
            v-model="form.specialRequirements"
            multiple
            placeholder="é€‰æ‹©ç‰¹æ®Šè¦æ±‚ï¼ˆå¯å¤šé€‰ï¼‰"
            class="w-full"
          >
            <ElOption label="æ— éšœç¢è®¾è®¡" value="æ— éšœç¢è®¾è®¡" />
            <ElOption label="å¤šè¯­è¨€æ”¯æŒ" value="å¤šè¯­è¨€æ”¯æŒ" />
            <ElOption label="äº’åŠ¨ä½“éªŒåŒº" value="äº’åŠ¨ä½“éªŒåŒº" />
            <ElOption label="æ–‡åˆ›äº§å“é”€å”®" value="æ–‡åˆ›äº§å“é”€å”®" />
            <ElOption label="ç¤¾äº¤åª’ä½“åˆ†äº«" value="ç¤¾äº¤åª’ä½“åˆ†äº«" />
            <ElOption label="å„¿ç«¥å‹å¥½" value="å„¿ç«¥å‹å¥½" />
            <ElOption label="VIPæœåŠ¡" value="VIPæœåŠ¡" />
            <ElOption label="å¤œé—´å±•è§ˆ" value="å¤œé—´å±•è§ˆ" />
          </ElSelect>
        </ElFormItem>

        <ElFormItem label="å…¶ä»–è¦æ±‚">
          <ElInput
            v-model="otherRequirements"
            type="textarea"
            :rows="3"
            placeholder="å¦‚æœæœ‰å…¶ä»–ç‰¹æ®Šè¦æ±‚ï¼Œè¯·åœ¨æ­¤è¯´æ˜"
          />
        </ElFormItem>
      </div>

      <!-- è¿­ä»£ä¼˜åŒ–é…ç½® -->
      <div class="mb-10">
        <div class="flex items-center mb-8">
          <div class="warning-gradient p-3 rounded-xl mr-4">
            <ElIcon class="text-white text-xl"><Setting /></ElIcon>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gradient">è¿­ä»£ä¼˜åŒ–é…ç½®</h2>
            <p class="text-gray-600">é…ç½®è´¨é‡è¯„ä¼°å’Œè¿­ä»£ä¼˜åŒ–å‚æ•°</p>
          </div>
        </div>

        <ElFormItem label="æœ€å¤§è¿­ä»£æ¬¡æ•°">
          <ElSlider
            v-model="maxIterations"
            :min="1"
            :max="5"
            :marks="{ 1: '1æ¬¡', 3: '3æ¬¡', 5: '5æ¬¡' }"
            show-input
            :show-input-controls="false"
          />
          <template #label>
            <div class="flex items-center space-x-2">
              <span>æœ€å¤§è¿­ä»£æ¬¡æ•°</span>
              <ElTooltip content="ç³»ç»Ÿä¼šæ ¹æ®è´¨é‡è¯„ä¼°è‡ªåŠ¨è¿›è¡Œè¿­ä»£ä¼˜åŒ–ï¼Œæå‡è®¾è®¡è´¨é‡" placement="top">
                <ElIcon class="text-gray-400 cursor-help"><InfoFilled /></ElIcon>
              </ElTooltip>
            </div>
          </template>
        </ElFormItem>

        <ElFormItem label="è‡ªåŠ¨æ‰¹å‡†æ¨¡å¼">
          <div class="flex items-center space-x-4">
            <ElSwitch
              v-model="autoApprove"
              active-text="å¼€å¯"
              inactive-text="å…³é—­"
              :active-value="true"
              :inactive-value="false"
              style="--el-switch-on-color: #13ce66; --el-switch-off-color: #dcdfe6"
            />
            <ElTooltip content="å¼€å¯åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é€šè¿‡è´¨é‡å®¡æ ¸å¹¶å®Œæˆè®¾è®¡ï¼›å…³é—­åï¼Œå°†åœ¨å®¡æ ¸ç‚¹ç­‰å¾…äººå·¥å†³ç­–" placement="top">
              <ElIcon class="text-gray-400 cursor-help"><InfoFilled /></ElIcon>
            </ElTooltip>
          </div>
        </ElFormItem>

        <div class="mt-4 p-4 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200">
          <div class="flex items-start space-x-3">
            <ElIcon class="text-blue-500 mt-1"><InfoFilled /></ElIcon>
            <div class="flex-1">
              <div class="font-semibold text-gray-800 mb-2">æ™ºèƒ½è¿­ä»£ä¼˜åŒ–</div>
              <div class="text-sm text-gray-600 space-y-1">
                <p>â€¢ ä¸»ç®¡æ™ºèƒ½ä½“ä¼šå¯¹è®¾è®¡æ–¹æ¡ˆè¿›è¡Œå¤šç»´åº¦è´¨é‡è¯„ä¼°</p>
                <p>â€¢ æ ¹æ®è¯„ä¼°ç»“æœï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿”å›ç›¸åº”ç¯èŠ‚è¿›è¡Œä¼˜åŒ–</p>
                <p>â€¢ æ”¯æŒé¢„ç®—é¢„è­¦ã€è®¾è®¡åè°ƒæ€§æ£€æŸ¥ç­‰å¤šé‡è´¨é‡ä¿éšœ</p>
                <p class="text-blue-600">â€¢ å½“å‰é…ç½®ï¼šæœ€å¤šè¿­ä»£ {{ maxIterations }} æ¬¡</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æäº¤æŒ‰é’® -->
      <div class="flex justify-center space-x-6 mt-12">
        <button
          @click="resetForm"
          class="px-8 py-4 rounded-xl font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 transition-all duration-300 hover:scale-105 active:scale-95 flex items-center space-x-2"
        >
          <ElIcon><RefreshRight /></ElIcon>
          <span>é‡ç½®è¡¨å•</span>
        </button>
        <button
          @click="submitForm"
          :disabled="submitting"
          class="btn-primary px-8 py-4 flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <ElIcon v-if="!submitting"><Plus /></ElIcon>
          <ElIcon v-else class="animate-spin"><Loading /></ElIcon>
          <span>{{ submitting ? 'æ™ºèƒ½ä½“æ­£åœ¨å¯åŠ¨...' : 'å¯åŠ¨å¤šæ™ºèƒ½ä½“è®¾è®¡' }}</span>
        </button>
      </div>
    </ElForm>

    <!-- æ¨¡å‹é…ç½®æ˜¾ç¤º -->
    <div class="glass rounded-2xl p-8 mt-12 slide-in-up" style="animation-delay: 0.6s">
      <div class="flex items-center mb-6">
        <div class="hero-gradient p-3 rounded-xl mr-4">
          <ElIcon class="text-white text-xl"><Cpu /></ElIcon>
        </div>
        <div>
          <h3 class="text-xl font-bold text-gradient">AIæ¨¡å‹é…ç½®</h3>
          <p class="text-gray-600">å½“å‰ä½¿ç”¨çš„æ™ºèƒ½æ¨¡å‹å‚æ•°</p>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="text-center p-4 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50">
          <div class="text-2xl font-bold text-blue-600 mb-2">
            {{ modelConfig?.provider || 'DeepSeek' }}
          </div>
          <div class="text-sm text-gray-600">æ¨¡å‹æä¾›å•†</div>
        </div>
        <div class="text-center p-4 rounded-xl bg-gradient-to-br from-purple-50 to-pink-50">
          <div class="text-2xl font-bold text-purple-600 mb-2">
            {{ modelConfig?.modelName || 'deepseek-chat' }}
          </div>
          <div class="text-sm text-gray-600">æ¨¡å‹åç§°</div>
        </div>
        <div class="text-center p-4 rounded-xl bg-gradient-to-br from-green-50 to-teal-50">
          <div class="text-2xl font-bold text-green-600 mb-2">
            {{ modelConfig?.temperature || 0.7 }}
          </div>
          <div class="text-sm text-gray-600">æ¸©åº¦å‚æ•°</div>
        </div>
        <div class="text-center p-4 rounded-xl bg-gradient-to-br from-yellow-50 to-orange-50">
          <div class="text-2xl font-bold text-orange-600 mb-2">6</div>
          <div class="text-sm text-gray-600">æ™ºèƒ½ä½“æ•°é‡</div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox, type FormInstance, type FormRules } from 'element-plus'
import { useExhibitionStore } from '@/stores/exhibition'
import {
  InfoFilled,
  Location,
  Money,
  Calendar,
  Star,
  Cpu,
  Setting
} from '@element-plus/icons-vue'
import type { ExhibitionRequirement } from '@/types/exhibition'

const router = useRouter()
const exhibitionStore = useExhibitionStore()

const formRef = ref<FormInstance>()
const submitting = ref(false)
const otherRequirements = ref('')
const modelConfig = exhibitionStore.modelConfig
const maxIterations = ref(3) // æ–°å¢ï¼šæœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡
const autoApprove = ref(false) // æ–°å¢ï¼šè‡ªåŠ¨æ‰¹å‡†æ¨¡å¼ï¼Œé»˜è®¤å…³é—­ï¼ˆäººå·¥å®¡æ ¸ï¼‰

// è®¡ç®—é»˜è®¤æ—¥æœŸ
const today = new Date()
const nextWeek = new Date(today)
nextWeek.setDate(today.getDate() + 7)

const formatDateForInput = (date: Date) => {
  return date.toISOString().split('T')[0]
}

const form = reactive<ExhibitionRequirement>({
  title: 'æœ¨å…°é™‚å±•é™ˆä¸­å¿ƒ',
  theme: 'å†å²æ–‡åŒ–ä»·å€¼ï¼Œæ°´æ–‡çŸ¥è¯†ï¼Œæ–°æ—¶ä»£æ„ä¹‰',
  targetAudience: 'general_public',
  venueSpace: {
    area: 500,
    height: 3.5,
    layout: ''
  },
  budget: {
    total: 300000,
    currency: 'CNY'
  },
  duration: {
    startDate: formatDateForInput(today),
    endDate: formatDateForInput(nextWeek)
  },
  specialRequirements: [],
  maxIterations: 3 // æ–°å¢ï¼šé»˜è®¤å€¼
})

const rules: FormRules = {
  title: [
    { required: true, message: 'è¯·è¾“å…¥å±•è§ˆåç§°', trigger: 'blur' },
    { min: 2, max: 50, message: 'é•¿åº¦åœ¨ 2 åˆ° 50 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ],
  theme: [
    { required: true, message: 'è¯·è¾“å…¥å±•è§ˆä¸»é¢˜', trigger: 'blur' },
    { min: 10, max: 200, message: 'é•¿åº¦åœ¨ 10 åˆ° 200 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ],
  targetAudience: [
    { required: true, message: 'è¯·é€‰æ‹©ç›®æ ‡å—ä¼—', trigger: 'change' }
  ],
  'venueSpace.area': [
    { required: true, message: 'è¯·è¾“å…¥åœºåœ°é¢ç§¯', trigger: 'blur' },
    { type: 'number', min: 50, message: 'é¢ç§¯ä¸èƒ½å°äº 50 å¹³æ–¹ç±³', trigger: 'blur' }
  ],
  'venueSpace.height': [
    { required: true, message: 'è¯·è¾“å…¥åœºåœ°é«˜åº¦', trigger: 'blur' },
    { type: 'number', min: 2, message: 'é«˜åº¦ä¸èƒ½å°äº 2 ç±³', trigger: 'blur' }
  ],
  'budget.total': [
    { required: true, message: 'è¯·è¾“å…¥æ€»é¢„ç®—', trigger: 'blur' },
    { type: 'number', min: 10000, message: 'é¢„ç®—ä¸èƒ½å°äº 10,000', trigger: 'blur' }
  ],
  'duration.startDate': [
    { required: true, message: 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ', trigger: 'change' }
  ],
  'duration.endDate': [
    { required: true, message: 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ', trigger: 'change' }
  ]
}

const submitForm = async () => {
  if (!formRef.value) return

  try {
    await formRef.value.validate()

    // ç¡®è®¤æäº¤
    await ElMessageBox.confirm(
      'æäº¤åå°†å¯åŠ¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿå¼€å§‹è®¾è®¡ï¼Œé¢„è®¡éœ€è¦ 3-5 åˆ†é’Ÿå®Œæˆã€‚ç¡®è®¤æäº¤å—ï¼Ÿ',
      'ç¡®è®¤æäº¤',
      {
        confirmButtonText: 'ç¡®è®¤',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'info'
      }
    )

    submitting.value = true

    // å¤„ç†å…¶ä»–è¦æ±‚
    if (otherRequirements.value.trim()) {
      form.specialRequirements.push(otherRequirements.value.trim())
    }

    // æ·»åŠ æœ€å¤§è¿­ä»£æ¬¡æ•°é…ç½®
    form.maxIterations = maxIterations.value

    // æ·»åŠ è‡ªåŠ¨æ‰¹å‡†æ¨¡å¼é…ç½®
    ;(form as any).autoApprove = autoApprove.value

    console.log('ğŸ“‹ [FORM] æäº¤é…ç½®:', {
      maxIterations: maxIterations.value,
      autoApprove: autoApprove.value
    })

    // å¯åŠ¨å¤šæ™ºèƒ½ä½“è®¾è®¡æµç¨‹
    await exhibitionStore.runExhibitionDesign(form)

    ElMessage.success('å±•è§ˆè®¾è®¡å·²å¯åŠ¨ï¼æ­£åœ¨è·³è½¬åˆ°å·¥ä½œæµé¡µé¢...')

    // è·³è½¬åˆ°å·¥ä½œæµé¡µé¢
    router.push('/workflow')

  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error)
    if (error !== 'cancel') {
      ElMessage.error('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  } finally {
    submitting.value = false
  }
}

const resetForm = () => {
  if (!formRef.value) return
  formRef.value.resetFields()
  otherRequirements.value = ''
}

onMounted(() => {
  exhibitionStore.initializeApp()
})
</script>