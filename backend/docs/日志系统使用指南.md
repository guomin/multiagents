# 后端日志系统使用指南

## 概述

本系统提供了全面的后端日志记录功能，包括智能体执行日志、API请求日志、性能监控和错误追踪。系统支持多种日志级别、文件轮转、实时监控和日志导出功能。

## 日志系统架构

### 核心组件

1. **Logger** (`src/utils/logger.ts`) - 基础日志记录器
2. **AgentLogger** (`src/utils/agent-logger.ts`) - 智能体专用日志管理器
3. **PerformanceMonitor** (`src/utils/performance-monitor.ts`) - 性能监控器
4. **RequestLogger** (`src/middleware/request-logger.ts`) - HTTP请求日志中间件

### 日志级别

- **DEBUG**: 调试信息，开发环境使用
- **INFO**: 一般信息，正常运行状态
- **WARN**: 警告信息，潜在问题
- **ERROR**: 错误信息，系统异常

## 使用方法

### 1. 基础日志记录

```typescript
import { createLogger } from '../utils/logger'

const logger = createLogger('MY-COMPONENT')

// 不同级别的日志
logger.debug('调试信息', { data: 'debug data' })
logger.info('一般信息', { userId: 123 })
logger.warn('警告信息', { issue: 'potential problem' })
logger.error('错误信息', error, { context: 'error context' })
```

### 2. 性能计时

```typescript
const endTimer = logger.time('耗时操作')

// 执行一些操作...
await someAsyncOperation()

endTimer() // 自动记录耗时
```

### 3. 智能体日志记录

```typescript
import { agentLogger } from '../utils/agent-logger'
import { logAgentExecution } from '../utils/agent-logger'

// 方式1: 手动记录
const executionId = agentLogger.startExecution('agent-id', '智能体名称', '执行任务', input)
// ... 执行任务
agentLogger.completeExecution('agent-id', executionId, output, metadata)

// 方式2: 使用装饰器
class MyAgent {
  @logAgentExecution('agent-id', '智能体名称', '任务描述')
  async myMethod(input: any): Promise<any> {
    // 方法实现
  }
}
```

### 4. 工作流日志

```typescript
// 记录工作流开始
agentLogger.logWorkflowStart(projectId, requirements)

// 记录工作流完成
agentLogger.logWorkflowComplete(projectId, result, totalDuration)

// 记录工作流错误
agentLogger.logWorkflowError(projectId, error, context)
```

## API接口

### 1. 系统日志

```http
GET /api/logs/system?level=INFO&count=100&agent=curator&category=API
```

**参数:**
- `level`: 日志级别 (DEBUG|INFO|WARN|ERROR)
- `count`: 返回条目数 (默认100)
- `agent`: 智能体ID (可选)
- `category`: 日志类别 (可选)

**响应:**
```json
{
  "success": true,
  "data": [
    {
      "timestamp": "2024-01-01T12:00:00.000Z",
      "level": "INFO",
      "category": "AGENT-CURATOR",
      "message": "智能体执行完成",
      "metadata": { "duration": 1500 }
    }
  ],
  "total": 1
}
```

### 2. 智能体日志

```http
GET /api/logs/agents?agentId=curator
```

**参数:**
- `agentId`: 智能体ID (可选，不提供则返回所有智能体状态)

**响应:**
```json
{
  "success": true,
  "data": {
    "currentStatus": {
      "curator": { "status": "idle" },
      "spatial": { "status": "running", "duration": 2000 }
    },
    "logs": {
      "curator": [
        {
          "agentId": "curator",
          "agentName": "策划智能体",
          "action": "执行任务",
          "startTime": "2024-01-01T12:00:00.000Z",
          "duration": 1500,
          "status": "completed"
        }
      ]
    }
  }
}
```

### 3. 请求日志

```http
GET /api/logs/requests?limit=100&stats=true
```

**参数:**
- `limit`: 返回条目数 (默认100)
- `requestId`: 特定请求ID (可选)
- `stats`: 返回统计信息 (true/false)

**响应:**
```json
{
  "success": true,
  "data": {
    "requestStats": {
      "totalRequests": 1250,
      "averageResponseTime": 245.6,
      "errorRate": 2.3,
      "statusCodes": { "200": 1200, "404": 30, "500": 20 }
    },
    "responseTimeStats": {
      "average": 245.6,
      "median": 210.0,
      "p95": 580.0,
      "p99": 1200.0
    },
    "slowRequests": [
      {
        "url": "/api/exhibition/run",
        "method": "POST",
        "duration": 5500,
        "timestamp": "2024-01-01T12:00:00.000Z"
      }
    ]
  }
}
```

### 4. 性能监控

```http
GET /api/logs/performance?history=true
```

**参数:**
- `history`: 返回历史数据 (true/false)

**响应:**
```json
{
  "success": true,
  "data": {
    "current": {
      "cpuUsage": { "total": 15.2 },
      "memoryUsage": { "percentage": 45.8 },
      "heapUsage": { "percentage": 32.1 },
      "uptime": 3600
    },
    "average": {
      "cpuUsage": { "total": 12.5 },
      "memoryUsage": { "percentage": 42.3 }
    },
    "thresholds": {
      "cpuUsage": 80,
      "memoryUsage": 85,
      "heapUsage": 90
    }
  }
}
```

### 5. 日志导出

```http
GET /api/logs/export?type=system&format=json&level=INFO
```

**参数:**
- `type`: 日志类型 (system|requests|agents|performance)
- `format`: 导出格式 (json|csv)
- `level`: 日志级别 (仅对system类型有效)
- `agent`: 智能体ID (仅对agents类型有效)

**响应:** 文件下载

### 6. 日志清理

```http
DELETE /api/logs/clear?type=agents
```

**参数:**
- `type`: 清理类型 (requests|agents|performance|不提供则清理所有)

## 配置选项

### 环境变量

```bash
# 日志级别
LOG_LEVEL=INFO

# 日志目录
LOG_DIR=./logs

# 启用文件日志
ENABLE_FILE_LOG=true

# 最大文件大小 (MB)
MAX_LOG_FILE_SIZE=50

# 最大文件数量
MAX_LOG_FILES=10
```

### 运行时配置

```typescript
import { logger } from '../utils/logger'

// 获取当前日志文件路径
const logFiles = logger.getLogFiles()

// 获取最近的日志条目
const recentLogs = await logger.getRecentLogs('INFO', 100)

// 配置性能监控阈值
performanceMonitor.updateThresholds({
  cpuUsage: 85,
  memoryUsage: 90
})
```

## 日志文件结构

### 文件组织

```
logs/
├── debug.log      # DEBUG级别日志
├── info.log       # INFO级别日志
├── warn.log       # WARN级别日志
└── error.log      # ERROR级别日志
```

### 日志格式

```
[2024-01-01 12:00:00.123] [INFO] [CATEGORY] 消息内容
  Metadata: {"key": "value"}
  Error: ErrorName: Error message
  Stack: Error stack trace
```

## 性能监控

### 监控指标

- **CPU使用率**: 系统CPU使用百分比
- **内存使用率**: 系统内存使用百分比
- **堆内存使用率**: Node.js堆内存使用百分比
- **响应时间**: API请求响应时间统计
- **错误率**: HTTP请求错误率

### 警报系统

```typescript
// 添加性能警报回调
performanceMonitor.addAlertCallback((metrics, alerts) => {
  console.warn('性能警报:', alerts)

  // 发送到监控系统
  sendToMonitoringSystem(alerts)
})
```

## 最佳实践

### 1. 日志级别使用

- **DEBUG**: 详细的调试信息，仅开发环境
- **INFO**: 重要的业务流程信息
- **WARN**: 可恢复的错误或性能问题
- **ERROR**: 系统错误和异常

### 2. 结构化日志

```typescript
// ✅ 好的做法
logger.info('用户登录成功', {
  userId: user.id,
  ip: req.ip,
  userAgent: req.get('User-Agent')
})

// ❌ 避免的做法
logger.info('用户 ' + user.id + ' 从 ' + req.ip + ' 登录成功')
```

### 3. 敏感信息处理

系统自动脱敏以下字段：
- password
- token
- key
- secret
- apiKey
- authorization
- auth

### 4. 性能考虑

- 生产环境建议使用INFO级别
- 定期清理旧的日志文件
- 监控日志文件大小和磁盘使用
- 使用日志轮转避免单文件过大

## 故障排除

### 常见问题

1. **日志文件无法创建**
   - 检查目录权限
   - 确保LOG_DIR环境变量正确设置

2. **性能监控数据不准确**
   - 确保在正确的环境中启用监控
   - 检查系统兼容性

3. **内存泄漏**
   - 定期调用清理方法
   - 监控日志条目数量

### 调试技巧

```typescript
// 检查日志配置
console.log('当前日志文件:', logger.getLogFiles())

// 检查智能体状态
const agentStatus = agentLogger.getAllAgentStatus()
console.log('智能体状态:', agentStatus)

// 检查性能统计
const perfStats = performanceMonitor.getPerformanceStats()
console.log('性能统计:', perfStats)
```

## 扩展功能

### 自定义日志处理器

```typescript
import { logger } from '../utils/logger'

// 添加自定义处理器
logger.addHandler((entry) => {
  // 发送到外部日志服务
  sendToLogService(entry)
})
```

### 集成监控系统

```typescript
// 集成Prometheus等监控工具
import { register } from 'prom-client'

// 注册自定义指标
const httpRequestDuration = new register.Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration in seconds'
})

// 在请求日志中间件中使用
requestDuration.observe(responseTime / 1000)
```

通过这个全面的日志系统，你可以有效地监控、调试和优化多智能体展陈设计系统的运行状态。